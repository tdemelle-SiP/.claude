# Load Into Creation Table Execution Audit (v2 - Post WIP Lifecycle Refactoring)

## Purpose
Trace the complete execution path of the "Load Into Creation Table" action after WIP lifecycle refactoring, with exact file locations and line numbers.

## Execution Trace

### Frontend Initiation (Steps 1-35)
1. User selects option "Load Into Creation Table" (dashboard-html.php:184)
2. Form submission triggers preventDefault (template-actions.js:39)
3. Calls handleTemplateActionFormSubmit() (template-actions.js:42)
4. Gets action value "check_and_load_template_wip" (template-actions.js:206)
5. Gets selected rows from DataTable (template-actions.js:212)
6. Checks if rows selected (template-actions.js:215)
7. Extracts templateTitle from selectedRows[0] (template-actions.js:223)
8. Extracts templateBasename from selectedRows[0] (template-actions.js:224)
9. Uses basename directly - no processing needed (template-actions.js:229)
10. Creates formData using createFormData() (template-actions.js:232)
11. Creates new FormData object (utilities.js:216)
12. Appends 'action' with config.ajaxAction (utilities.js:217)
13. Appends 'plugin' parameter (utilities.js:218)
14. Appends 'action_type' parameter (utilities.js:219)
15. Appends action_type value (utilities.js:220)
16. Appends 'nonce' from sipCoreAjax.nonce (utilities.js:223)
17. Returns FormData object (utilities.js:225)
18. Appends 'template_title' to formData (template-actions.js:233)
19. Calls handleAjaxAction() (template-actions.js:236)
20. Shows spinner if enabled (ajax.js:63)
21. Validates formData is FormData object (ajax.js:67)
22. Gets action from formData (ajax.js:73)
23. Gets plugin from formData (ajax.js:74)
24. Gets action_type from formData (ajax.js:75)
25. Validates action equals 'sip_handle_ajax_request' (ajax.js:77)
26. Validates plugin matches parameter (ajax.js:82)
27. Creates Promise for AJAX request (ajax.js:88)
28. Makes jQuery AJAX POST request (ajax.js:89)
29. Server receives request at 'sip_handle_ajax_request' (ajax-handler.php:52)
30. Gets plugin parameter from POST (ajax-handler.php:54)
31. Gets action_type parameter from POST (ajax-handler.php:55)
32. Verifies nonce security (ajax-handler.php:59)
33. Checks if plugin is in registered list (ajax-handler.php:76)
34. Triggers 'sip_plugin_handle_action' hook (ajax-handler.php:78)
35. Calls sip_printify_route_action() (printify-ajax-shell.php:15)

### Backend Processing - WIP Lifecycle (Steps 36-59) [REFACTORED]
36. Checks plugin_id equals 'sip-printify-manager' (printify-ajax-shell.php:27)
37. Switches on action_type 'creation_setup_action' (printify-ajax-shell.php:30)
38. Calls sip_handle_creation_setup_action() (printify-ajax-shell.php:44)
39. Gets creation_setup_action from POST (creation-table-setup-functions.php:185)
40. Switches to 'check_and_load_template_wip' case (creation-table-setup-functions.php:188)
41. Calls sip_ajax_check_and_load_template_wip() (creation-table-setup-functions.php:189)
42. Calls sip_check_and_load_template_wip() internally (creation-table-setup-functions.php:139)
43. Gets template_name from parameter or POST (creation-table-setup-functions.php:19-23)
44. Gets WIP directory path (creation-table-setup-functions.php:29)
45. Gets existing WIP files with glob() (creation-table-setup-functions.php:30)
46. If WIP exists, reads and parses JSON once (creation-table-setup-functions.php:35-45)
47. Checks if existing WIP matches requested template (creation-table-setup-functions.php:57-59)
48. If mismatch, deletes old WIP file (creation-table-setup-functions.php:63)
49. If no WIP or mismatch, creates new WIP (creation-table-setup-functions.php:68)
50. Calls sip_create_wip_file() (creation-table-setup-functions.php:71)
51. Uses basename directly - already processed (creation-table-setup-functions.php:198)
52. Constructs template and WIP paths (creation-table-setup-functions.php:199,210)
53. Copies template to WIP with _wip suffix (creation-table-setup-functions.php:211)
54. Returns success with path (creation-table-setup-functions.php:220-223)
55. Loads newly created WIP data (creation-table-setup-functions.php:75-76)
56. Updates referenced images if data exists (creation-table-setup-functions.php:100-101)
57. Returns complete result structure (creation-table-setup-functions.php:107-127)
58. sip_ajax_check_and_load_template_wip() checks result (creation-table-setup-functions.php:141)
59. Prepares response_data array (creation-table-setup-functions.php:143-147)

### AJAX Response (Steps 60-84)
60. Sets creation_template_wip_data value (creation-table-setup-functions.php:144)
61. Sets creation_template_wip_name value (creation-table-setup-functions.php:145)
62. Sets template_file value (creation-table-setup-functions.php:146)
63. Calls SiP_AJAX_Response::success() (creation-table-setup-functions.php:149)
64. Creates response array structure (class-ajax-response.php:53)
65. Sets success to true (class-ajax-response.php:54)
66. Sets plugin to 'sip-printify-manager' (class-ajax-response.php:55)
67. Sets action_type to 'template_action' (class-ajax-response.php:56)
68. Sets action to 'check_and_load_template_wip' (class-ajax-response.php:57)
69. Sets message to 'Template WIP loaded successfully' (class-ajax-response.php:58)
70. Sets data with response_data array (class-ajax-response.php:59)
71. Sends JSON response with wp_send_json() (class-ajax-response.php:68)
72. Client receives AJAX response (ajax.js:98)
73. Hides spinner if shown (ajax.js:101)
74. Calls handleSuccessResponse() (ajax.js:109)
75. Routes to appropriate plugin handler (ajax.js:125)
76. Calls handleTemplateActionResponse() (ajax.js:189)
77. Calls processTemplateActionSuccess() (template-actions.js:338)
78. Routes to handleTemplateLoadSuccess() (creation-table-setup-actions.js:266)
79. Gets creation_template_wip_data from response (creation-table-setup-actions.js:267)
80. Gets creation_template_wip_name from response (creation-table-setup-actions.js:268)
81. Updates creationTemplateWipData (creation-table-setup-actions.js:283)
82. Sets data property with WIP data (creation-table-setup-actions.js:284)
83. Sets template_title with WIP name (creation-table-setup-actions.js:285)
84. Stores in window.creationTemplateWipData (creation-table-setup-actions.js:289)

### UI Updates (Steps 85-146)
85. Checks if productCreationTable exists (creation-table-setup-actions.js:292)
86. Calls clearProductCreationTable() (creation-table-setup-actions.js:293)
87. Gets DataTable instance (creation-table-setup-actions.js:389)
88. Calls clear() on table (creation-table-setup-actions.js:390)
89. Calls draw() to refresh display (creation-table-setup-actions.js:391)
90. Calls addNewRowWithWipData() (creation-table-setup-actions.js:297)
91. Gets child_products array from WIP data (creation-table-setup-actions.js:418)
92. Iterates through child_products (creation-table-setup-actions.js:421)
93. Creates rowData for each product (creation-table-setup-actions.js:423)
94. Adds row to DataTable (creation-table-setup-actions.js:448)
95. Redraws table after all rows added (creation-table-setup-actions.js:451)
96. Calls updateRelatedFields() (creation-table-setup-actions.js:301)
97. Updates variant count display (creation-table-setup-actions.js:462)
98. Updates template name field (creation-table-setup-actions.js:463)
99. Clears all dropdown values (creation-table-setup-actions.js:470)
100. Removes existing dropdown options (creation-table-setup-actions.js:471)
101. Resets dropdowns to default state (creation-table-setup-actions.js:472)
102. Calls getTemplateWipData() (creation-table-setup-actions.js:304)
103. Returns stored WIP data object (creation-table-setup-actions.js:511)
104. Checks if blueprint_id exists (creation-table-setup-actions.js:305)
105. Calls populateFieldsFromWip() (creation-table-setup-actions.js:310)
106. Sets blueprint value (creation-table-setup-actions.js:522)
107. Sets enable_variants checkbox (creation-table-setup-actions.js:523)
108. Sets enable_all_variants checkbox (creation-table-setup-actions.js:524)
109. Updates variant fields visibility (creation-table-setup-actions.js:525)
110. Checks and shows/hides alert (creation-table-setup-actions.js:311)
111. Updates product table highlighting (creation-table-setup-actions.js:322)
112. Gets templateData from response (creation-table-setup-actions.js:323)
113. Calls addRelationalClasses() (table-highlighting.js:45)
114. Gets blueprint_id from template data (table-highlighting.js:46)
115. Finds blueprint row in product table (table-highlighting.js:48)
116. Adds template-blueprint class (table-highlighting.js:50)
117. Gets source_product_id (table-highlighting.js:53)
118. Finds parent product row (table-highlighting.js:55)
119. Adds template-parent class (table-highlighting.js:57)
120. Iterates through child_products (table-highlighting.js:60)
121. Finds each child product row (table-highlighting.js:63)
122. Adds template-child-{status} class (table-highlighting.js:65)
123. Updates image table highlighting (creation-table-setup-actions.js:326)
124. Calls highlightRelatedImages() (image-actions.js:125)
125. Gets WIP data from window (image-actions.js:126)
126. Checks if WIP data exists (image-actions.js:127)
127. Gets src from WIP data (image-actions.js:128)
128. Finds matching image rows (image-actions.js:130)
129. Adds template-image class (image-actions.js:132)
130. Updates template table highlighting (creation-table-setup-actions.js:330)
131. Calls highlightSelectedTemplate() (template-actions.js:95)
132. Gets DataTable instance (template-actions.js:96)
133. Removes existing highlights (template-actions.js:97)
134. Finds matching template row (template-actions.js:99)
135. Adds template-selected class (template-actions.js:101)
136. Updates catalog images (creation-table-setup-actions.js:334)
137. Calls loadCatalogImages() (catalog-images.js:45)
138. Gets template name parameter (catalog-images.js:46)
139. Makes AJAX request for images (catalog-images.js:48)
140. Receives image data response (catalog-images.js:52)
141. Updates catalog display (catalog-images.js:54)
142. Shows product creation section (creation-table-setup-actions.js:337)
143. Removes hidden class (creation-table-setup-actions.js:338)
144. Displays creation table UI (creation-table-setup-actions.js:339)
145. Enables user interaction (creation-table-setup-actions.js:340)
146. Complete - user sees loaded template (creation-table-setup-actions.js:341)

## Key Changes from Original Audit

### Improved WIP Lifecycle (Steps 41-57)
- **Single Entry Point**: All WIP operations go through `sip_check_and_load_template_wip()`
- **Single File Read**: WIP file is read once and data passed through
- **Automatic Cleanup**: Old WIP files deleted when loading different template
- **Better Error Handling**: Structured return values with success/failure states
- **AJAX Wrapper**: Separation of business logic from response handling

### Benefits
1. **Performance**: Fewer file system operations (1-2 reads vs 3-4)
2. **Reliability**: Atomic operations reduce race conditions
3. **Maintainability**: Centralized WIP management
4. **Debugging**: Clearer execution flow with single entry point